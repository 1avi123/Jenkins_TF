pipeline {
agent any
 stages { 
   stage ('Checkout Repo') { 
     steps { 
       cleanWs()
       sh  'git clone https://github.com/UnixArena/terraform-test.git'
      }
      } 

stage ('TF installation') { 
  steps {
   sh '''
    #!/bin/bash
    set +x 
    sudo yum install -y jq
    cd /usr/local/src
    sudo wget https://releases.hashicorp.com/terraform/0.12.25/terraform_0.12.25_linux_amd64.zip
    sudo unzip -o terraform_0.12.25_linux_amd64.zip
    sudo cp -rf terraform /usr/local/bin/
   /usr/local/bin/terraform --version
   ''' 
    }
    }
    
  stage ('TF initialize') { 
  steps {
   sh '''
   #sudo mkdir -p /home/jenkins/.aws
   #sudo echo Credential_source = Ec2InstanceMetadata  > /home/jenkins/.aws/config
   #sudo echo role_arn = arn:aws:iam::476227053747:role/gitansible >> /home/jenkins/.aws/config
   echo AWS_PROFILE=ansible >> ${WORKSPACE}/env.properties
   cd terraform-test/
   /usr/local/bin/terraform init
   ''' 
   }
   }
   
  stage ('TF plan') { 
  steps {
   sh '''
   cd terraform-test/
   /usr/local/bin/terraform plan
   ''' 
   }
   }
   
 stage ('TF apply') { 
  steps {
   sh '''
   cd terraform-test/
   /usr/local/bin/terraform apply --auto-approve
   ''' 
   }
        post { 
        always { 
            cleanWs()
         }
        }
       }
  }
}
